<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flutter Logs</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background-color: #f4f4f9;
        color: #333;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      header {
        background: linear-gradient(135deg, #6200ea, #7c4dff);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        flex-shrink: 0;
        font-size: 1.2em;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      }
      header h3 {
        margin: 0;
        font-size: 1.4em;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
      }
      .search-container {
        position: relative;
      }
      #searchInput {
        padding: 0.6rem 1rem;
        border-radius: 20px;
        border: none;
        outline: none;
        width: 240px;
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 1em;
        transition: background-color 0.3s ease;
      }
      #searchInput::placeholder {
        color: rgba(255, 255, 255, 0.7);
      }
      #logContainer {
        flex-grow: 1;
        padding: 1rem;
        margin: 1rem;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
      }
      .log-entry {
        margin-bottom: 12px;
        padding: 16px;
        border-radius: 10px;
        background-color: #f8f9fa;
        font-size: 1.1em;
        line-height: 1.6;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .log-level {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        font-weight: bold;
      }

      .log-message {
        margin: 8px 0;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .log-timestamp {
        font-size: 0.9em;
        color: #555;
      }

      @media (max-width: 768px) {
        header {
          flex-direction: column;
          gap: 1rem;
          padding: 1rem;
          font-size: 1.1em;
        }

        #searchInput {
          width: 100%;
          max-width: 320px;
          font-size: 0.95em;
        }

        #logContainer {
          margin: 0.6rem;
          padding: 0.8rem;
        }

        .log-entry {
          padding: 12px;
          font-size: 1em;
        }
      }

      @media (max-width: 480px) {
        header {
          font-size: 1em;
        }

        #searchInput {
          width: 100%;
          font-size: 0.9em;
        }

        .log-entry {
          padding: 10px;
          font-size: 0.9em;
        }

        .log-level {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h3 style="margin: 0; font-size: 1.1em">Logging</h3>
      <div class="search-container">
        <input
          type="text"
          id="searchInput"
          placeholder="Search messages..."
          autocomplete="off"
        />
      </div>
    </header>
    <div id="logContainer"></div>

    <script>
      const logContainer = document.getElementById("logContainer");
      const searchInput = document.getElementById("searchInput");
      const eventSource = new EventSource("/stream_flutter_logs");

      let allLogs = [];
      let autoScroll = true; // Flag to track if auto-scrolling is enabled

      eventSource.onopen = () => {
        console.log("Connection to /flutter_logs opened.");
      };

      eventSource.onmessage = (event) => {
        const logEntry = JSON.parse(event.data); // Parse structured JSON log
        allLogs.push(logEntry); // Add to log list
        displayLogs(); // Update displayed logs
      };

      // Function to display logs
      function displayLogs() {
        logContainer.innerHTML = ""; // Clear container

        // Filter logs based on search input
        const searchTerm = searchInput.value.trim().toLowerCase();
        const filteredLogs = allLogs.filter(
          (log) =>
            log.message.toLowerCase().includes(searchTerm) ||
            log.level.replace("Level.", "").toLowerCase() === searchTerm
        );

        // Display each log
        filteredLogs.forEach((logEntry) => {
          const container = document.createElement("div");
          container.className = "log-entry";

          const emoji = getEmojiForLevel(logEntry.level.toLowerCase());
          const formattedTimestamp = formatDate(new Date(logEntry.timestamp));
          const color = getColorForLevel(logEntry.level.toLowerCase());

          container.style.color = color;

          container.innerHTML = `
            <div class="log-level">
              <span>${emoji}</span>
            </div>
            <div class="log-message">${logEntry.message}</div>
            <div class="log-timestamp">${formattedTimestamp}</div>
          `;

          logContainer.appendChild(container);
        });

        // Auto-scroll if enabled
        if (autoScroll) {
          logContainer.scrollTop = logContainer.scrollHeight;
        }
      }

      // Get emoji for log level
      function getEmojiForLevel(level) {
        if (level.includes("debug")) return "🐛";
        if (level.includes("info")) return "💡";
        if (level.includes("warning")) return "⚠";
        if (level.includes("error")) return "⛔";
        if (level.includes("fatal")) return "🔥";
        return "ℹ";
      }

      // Get color for log level
      function getColorForLevel(level) {
        if (level.includes("debug")) return "black";
        if (level.includes("info")) return "#2196F3";
        if (level.includes("warning")) return "orange";
        if (level.includes("error")) return "red";
        if (level.includes("fatal")) return "purple";
        return "gray";
      }

      // Format a date as dd.MM.yyyy | HH:mm:ss
      function formatDate(date) {
        const pad = (num) => String(num).padStart(2, "0");
        const day = pad(date.getDate());
        const month = pad(date.getMonth() + 1);
        const year = date.getFullYear();
        const hours = pad(date.getHours());
        const minutes = pad(date.getMinutes());
        const seconds = pad(date.getSeconds());
        return `${day}.${month}.${year} | ${hours}:${minutes}:${seconds}`;
      }

      // Handle search input
      searchInput.addEventListener("input", displayLogs);

      // Disable auto-scroll if the user scrolls up
      logContainer.addEventListener("scroll", () => {
        const nearBottom =
          logContainer.scrollTop + logContainer.clientHeight >=
          logContainer.scrollHeight - 10;
        autoScroll = nearBottom;
      });

      // Handle EventSource errors
      eventSource.onerror = (error) => {
        console.error("EventSource failed:", error);
      };
    </script>
  </body>
</html>
